WITH COB_CREDITO AS ( 
SELECT 		A.NUMERO_CREDITO,
			TRUNC(A.FECHA_CREACION) FECHA,
			TO_CHAR(A.FECHA_CREACION, 'YYYYmm') MES,
			TO_CHAR(A.FECHA_CREACION, 'DD')DIA,
			CUOTAS_PACTADAS PLAZO,
			IMEI,
			CUSTCODE_DEL_SERVICIO CUSTCODE_SERVICIO,
			TIPO_PROCESO,
			SALDO_FINANCIAR VR_FINANCIACION,
			REFERENCIA_EQUIPO REF_EQUIPO,
			CODIGO_DISTRIBUIDOR COD_DISTRIBUIDOR,
			DIVISION,
			VALOR_PAGO_TOTAL SALDO, 
			SALDO_FINANCIAR,
			VALOR_VENTA,
			CUOTAS_PENDIENTES,
			CUOTAS_FACTURADAS,
			SALDO_DIFERIDO_VENTA,
			ESTADO_CREDITO,
			A.CO_ID,
			B.TIPO_IDENTIFICACION,
			B.NUMERO_IDENTIFICACION,
			B.CIUDAD,
			B.DEPARTAMENTO,
			A.EDAD_MORA_DIARIA
FROM 	CASOS_USO.GCCO_COB_CREDITO_30 A
LEFT JOIN 	CASOS_USO.GCCO_COB_CLIENTES_30 B ON B.NUMERO_CREDITO = A.NUMERO_CREDITO
WHERE TO_CHAR(A.FECHA_CREACION, 'YYYYmm') = "+context.Fecha_Filtro+"
)
SELECT 		A.NUMERO_CREDITO CREDITO ,
			A.MES,
			A.DIA,
			A.PLAZO,
 			(CASE WHEN A.TIPO_PROCESO IN (5,6) AND D.FECHA_SERVICIO IS NOT NULL AND  TRUNC(TO_DATE(D.FECHA_SERVICIO))  <= FECHA THEN  TRUNC(TO_DATE(D.FECHA_SERVICIO)) 
				  WHEN A.TIPO_PROCESO NOT IN (5,6) AND  E.FECHA_ACTIVACION_BSCS IS NOT NULL AND  TRUNC(E.FECHA_ACTIVACION_BSCS) <= FECHA THEN  TRUNC(E.FECHA_ACTIVACION_BSCS)
				  ELSE FECHA 
			END)  FECHA_SERVICIO,
			A.IMEI,
			A.CUSTCODE_SERVICIO,
			A.TIPO_PROCESO,
			NVL (F.VLR_NETO,NVL (A.VR_FINANCIACION,0)) VR_EQUIPO,
			NVL (F.VLR_IMPUESTO,0 )	IVA_EQUIPO,
			NVL (A.VR_FINANCIACION,0) VR_FINANCIACION,
			A.REF_EQUIPO,
			A.COD_DISTRIBUIDOR,
			A.DIVISION,
			A.TIPO_IDENTIFICACION,
			A.NUMERO_IDENTIFICACION  NUMERO_IDENTIF,
			NVL (A.SALDO,0)SALDO,
			A.CUOTAS_PENDIENTES C_PACT_MENOS_C_FINANC, 
			A.SALDO_DIFERIDO_VENTA SALDO_DIFERIDO_VTA,
			A.ESTADO_CREDITO,
			ROUND(CASE WHEN NVL (F.VLR_NETO,NVL (A.VR_FINANCIACION,0))+NVL (F.VLR_IMPUESTO,0 ) < NVL (A.VR_FINANCIACION,0) THEN 0 
				 WHEN NVL (F.VLR_NETO,NVL (A.VR_FINANCIACION,0))+NVL (F.VLR_IMPUESTO,0 ) >  0 THEN 1-(A.VR_FINANCIACION/( NVL (F.VLR_NETO,NVL (A.VR_FINANCIACION,0))+NVL (F.VLR_IMPUESTO,0 )) )
				 ELSE 0
			END , 2) PORCENTAJE_CI,
			NVL (C.PAGOS_CANT,0)PAGOS_CANT,
			CASE WHEN A.TIPO_PROCESO IN (5,6) AND  D1.ESTRATO IS NOT NULL THEN  D1.ESTRATO 
				 WHEN A.TIPO_PROCESO IN (5,6) AND  D1.ESTRATO IS  NULL THEN  'ND'
			     ELSE 'MOVIL' 
			END ESTRATO,
			A.CIUDAD,
			A.DEPARTAMENTO,
			G.CARTERA,
			G.ESTADO_CARTERA_WS,
		    NVL( TO_NUMBER (CASE WHEN A.TIPO_PROCESO IN (5,6) THEN  D.CFM ELSE E.VLR_CFM END ),0) CFM,
			ROUND(A.VR_FINANCIACION/(CASE WHEN NVL(A.PLAZO,1)=0 THEN 1 ELSE NVL(A.PLAZO,1)END),2) VR_CUOTA_CALCULADA, 
--CANAL
---------> adicionales
			A.CO_ID,	
			A.FECHA,			
			A.SALDO_FINANCIAR,	
			A.EDAD_MORA_DIARIA ,
			E.COMPORTAMIENTO_PAGO
FROM 		(SELECT 	*							
			 FROM 		COB_CREDITO A
)A
--------------------------------------------------> CANTIDAD DE PAGOS
LEFT JOIN (SELECT 		B.NUMERO_CREDITO, 
						COUNT(B.NUMERO_CREDITO) PAGOS_CANT
			FROM 		COB_CREDITO A, CASOS_USO.GCCO_COB_MOVIMIENTO_30 B ---- CASOS_USO.V_GCCO_COB_MOVIMIENTO_30  B
			WHERE 		A.NUMERO_CREDITO = B.NUMERO_CREDITO
			AND 		B.CODIGO_TRANSACCION = 95
			GROUP BY 	B.NUMERO_CREDITO
) C ON C.NUMERO_CREDITO=A.NUMERO_CREDITO
---------------------------------------------------> RR --> ESTRATO,CFM,FECHA SERVICIO (HOGARES)
LEFT JOIN ( SELECT * 
			FROM(  SELECT 	 	A.CEDULA,
								A.VALOR_CB CFM,
								A.DTESTR ESTRATO,
								A.FECCONEXION FECHA_SERVICIO,
								ROW_NUMBER() OVER (PARTITION BY CEDULA ORDER BY FECHA_SERVICIO ASC) ORDEN
					FROM 	CASOS_USO.GCCO_HOGARES_MASTER_30 A ----	CASOS_USO.V_GCCO_HOGARES_MASTER_30 A
					INNER JOIN COB_CREDITO B ON B.NUMERO_IDENTIFICACION=A.CEDULA
					WHERE CEDULA IS NOT NULL
					AND A.FECCONEXION NOT IN('0000-00-00')
			) A
			WHERE A.ORDEN=1
)D ON D.CEDULA=A.NUMERO_IDENTIFICACION
------------------------------------------------------ESTRATO
LEFT JOIN ( SELECT * 
			FROM(  SELECT 	 	A.CEDULA,
								A.DTESTR ESTRATO,
								ROW_NUMBER() OVER (PARTITION BY CEDULA ORDER BY FECCONEXION ASC) ORDEN
					FROM 	CASOS_USO.GCCO_HOGARES_MASTER_30 A ---CASOS_USO.V_GCCO_HOGARES_MASTER_30 A
					INNER JOIN COB_CREDITO B ON B.NUMERO_IDENTIFICACION=A.CEDULA
					WHERE CEDULA IS NOT NULL
					AND A.FECCONEXION NOT IN('0000-00-00')
					AND A.DTESTR IS NOT NULL
			) A
			WHERE A.ORDEN=1
)D1 ON D1.CEDULA=A.NUMERO_IDENTIFICACION
------------------------------------------> Td_ Contratos
LEFT JOIN(  
			SELECT 	A.* , 
					B.VLR_CFM
			FROM(  	SELECT 	DISTINCT	A.CO_ID ,
								A.FECHA_ACTIVACION_BSCS , 
								A.COD_PLAN_ACTUAL, 
								A.COD_PLAN_INICIAL , 
								A.CIUDAD, 
								A.EDAD_MORA,
								A.COMPORTAMIENTO_PAGO
					FROM 		COB_CREDITO  B
					INNER JOIN 	CASOS_USO.V_GCCO_INH_SEG_BSCS_CLIENTES A ON B.CO_ID=A.CO_ID
			)A
			-----------------------------------------------segmentacion ws		
			LEFT JOIN (
						SELECT * 
						FROM CASOS_USO.V_GCCO_INH_DIM_PLANES
			)B ON B.COD_PLAN=A.COD_PLAN_INICIAL
)E ON E.CO_ID=A.CO_ID
---------------------------------------------> SAP TABLA
LEFT JOIN(	SELECT* 
		    FROM(
					SELECT 		A.numero_de_serie IMEI,
								A.VALOR_NETO VLR_NETO,
								nvl(A.VALOR_IMPUESTO,0) VLR_IMPUESTO, 
								ROW_NUMBER() OVER(PARTITION BY A.numero_de_serie ORDER BY A.FECHA_DOC DESC)CONTEO 
					FROM 		CASOS_USO.V_GCCO_VENTAS_SAP A
					INNER JOIN (SELECT DISTINCT IMEI from COB_CREDITO )B ON Lpad(B.IMEI , 18, '0') = Lpad(A.numero_de_serie , 18, '0')  
					WHERE 		A.numero_de_serie IS NOT NULL
					and 		A.clfac <> 'ZRE'
					AND  		A.VALOR_NETO>=0					
			)A WHERE A.CONTEO=1				
)F ON Lpad(F.IMEI , 18, '0') = Lpad(A.IMEI , 18, '0')  
---------------------------------------------> SEGMENTACION
LEFT JOIN(
			SELECT 		DISTINCT
		--				a.IMEI,
						A.NUMERO_CREDITO,
						SEGMENTO CARTERA,
						NOMBRE_WS ESTADO_CARTERA_WS
			FROM CASOS_USO.GCCO_COBCRED_ACTFIN	 A
			inner join  ( SELECT DISTINCT IMEI FROM CASOS_USO.GCCO_COB_CREDITO)  B ON B.IMEI=A.IMEI
) G ON G.NUMERO_CREDITO=A.NUMERO_CREDITO
